var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);i.prototype=e.prototype,t.prototype=new i},__awaiter=this&&this.__awaiter||function(t,e,i,n){return new(i||(i=Promise))(function(r,a){function o(t){try{h(n.next(t))}catch(e){a(e)}}function s(t){try{h(n["throw"](t))}catch(e){a(e)}}function h(t){t.done?r(t.value):new i(function(e){e(t.value)}).then(o,s)}h((n=n.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){function i(t){return function(e){return n([t,e])}}function n(i){if(r)throw new TypeError("Generator is already executing.");for(;h;)try{if(r=1,a&&(o=a[2&i[0]?"return":i[0]?"throw":"next"])&&!(o=o.call(a,i[1])).done)return o;switch(a=0,o&&(i=[0,o.value]),i[0]){case 0:case 1:o=i;break;case 4:return h.label++,{value:i[1],done:!1};case 5:h.label++,a=i[1],i=[0];continue;case 7:i=h.ops.pop(),h.trys.pop();continue;default:if(o=h.trys,!(o=o.length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){h=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){h.label=i[1];break}if(6===i[0]&&h.label<o[1]){h.label=o[1],o=i;break}if(o&&h.label<o[2]){h.label=o[2],h.ops.push(i);break}o[2]&&h.ops.pop(),h.trys.pop();continue}i=e.call(t,h)}catch(n){i=[6,n],a=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var r,a,o,s,h={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return s={next:i(0),"throw":i(1),"return":i(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s},ecs;!function(t){function e(t){if(r.has(t))return r.get(t);var e=new a(null);return r.set(t,e),e}function i(t){var e=t instanceof egret.DisplayObject?t.hashCode+"":t;return r.has(e)?r.get(e):null}function n(t,e){var i=e?e:t.hashCode+"";if(r.has(i))return r.get(i);var n=new a(t);return r.set(i,n),n}var r=new Map;t.create=e,t.find=i,t.createByRaw=n;var a=function(){function t(t){this._comps=new vitamin.Hashtable,this._raw=t,this.onCreate()}return Object.defineProperty(t.prototype,"raw",{get:function(){return this._raw},enumerable:!0,configurable:!0}),t.prototype.onCreate=function(){vitamin.ticker.frame(this,this.updateHandler)},t.prototype.destory=function(){vitamin.ticker.remove(this,this.updateHandler),this._comps.forEach(function(t){vitamin.ObjectPool.to(t,!0)}),this._comps.clear(),this._raw&&(this._raw.parent&&this._raw.parent.removeChild(this._raw),this._raw=null)},t.prototype.updateHandler=function(){for(var t=this._comps.$list,e=0;e<t.length;e++)t[e].onUpdate()},t.prototype.add=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var i=0,n=t;i<n.length;i++){var r=n[i],a=egret.getQualifiedClassName(r);if(this._comps.has(a))return void console.warn("重复添加组件...",a);var o=vitamin.ObjectPool.from(r);o.entity=this,o.__onCreate(),o.initialize(),this._comps.set(a,o)}return this},t.prototype.remove=function(t){var e=egret.getQualifiedClassName(t);if(!this._comps.has(e))return void console.warn("没有组件可以移除...",e);var i=this._comps.remove(e);vitamin.ObjectPool.to(i,!0),i.entity=null},t.prototype.find=function(t){var e=egret.getQualifiedClassName(t);return this._comps.get(e)},t}();t.Entity=a,__reflect(a.prototype,"ecs.Entity");var o=function(){function t(){}return Object.defineProperty(t.prototype,"enabled",{set:function(t){this._enabled!=t&&(this._enabled=t,this._enabled?this.onEnable():this.onDisable())},enumerable:!0,configurable:!0}),t.prototype.__onCreate=function(){this.__created||(this.__created=!0,this.onCreate())},t.prototype.initialize=function(){this.onStart(),this.enabled=!0},t.prototype.uninitialize=function(){this.enabled=!1,this.onDestory()},t.prototype.onCreate=function(){},t.prototype.onStart=function(){},t.prototype.onUpdate=function(){},t.prototype.onEnable=function(){},t.prototype.onDisable=function(){},t.prototype.onDestory=function(){},t}();t.Component=o,__reflect(o.prototype,"ecs.Component",["vitamin.IPool"])}(ecs||(ecs={}));var Main=function(t){function e(){var e=t.call(this)||this;return egret.lifecycle.addLifecycleListener(function(t){}),egret.lifecycle.onPause=function(){egret.ticker.pause()},egret.lifecycle.onResume=function(){egret.ticker.resume()},e.runGame(),e}return __extends(e,t),e.prototype.runGame=function(){return __awaiter(this,void 0,void 0,function(){var t,e,i;return __generator(this,function(n){switch(n.label){case 0:return[4,RES.loadConfig("resource/default.res.json","resource/")];case 1:return n.sent(),[4,RES.loadGroup("preload",0)];case 2:return n.sent(),vitamin.initialize(this.stage,{appName:"game.kevin.fruitlegend",platform:platform.inst},{dragonbone:!0,key:!0}),t=new tiled.TMXTilemap(2e3,2e3,"resource/test.tmx"),[4,t.loadMap()];case 3:return n.sent(),t.initialize(),t.render(),[4,t.waitTileSetsLoad()];case 4:return n.sent(),egret.lifecycle.stage.addChild(t),ecs.createByRaw(t,"Map").add(MapBitmapComp,MapGridComp),e=t.getLayerByName("Objects"),i=new Actor,[4,i.load()];case 5:return n.sent(),e.addChild(i),i.action="idel",i.setTile(5,5),ecs.createByRaw(i,"Actor").add(TapControlComp),[2]}})})},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var Actor=function(t){function e(){var e=t.call(this)||this;return e._tile={x:0,y:0},e}return __extends(e,t),e.prototype.load=function(){var t=this;return new Promise(function(e){RES.getResByUrl("resource/dragon_.png",function(i){t._actions=new Map;var n=new vitamin.SpriteSheet(i);t._actions.set("idel",[]),t._actions.set("run",[]);for(var r=0;4>r;r++)t._actions.get("idel").push(n.createTexture("idle"+r,24*r,0,24,24)),t._actions.get("run").push(n.createTexture("run"+r,24*r,48,24,24));t.anchor(12,24),e(null)})})},e.prototype.setTile=function(t,e){this._tile.x=t,this._tile.y=e,this.x=16*t+8,this.y=16*e+8},e.prototype.moveToTile=function(t,e){var i=this,n=16*t+8,r=16*e+8;this.action="run",egret.Tween.removeTweens(this),egret.Tween.get(this).to({x:n,y:r},300).call(function(){i.action="idel",i._tile.x=t,i._tile.y=e})},Object.defineProperty(e.prototype,"tile",{get:function(){return this._tile},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"action",{set:function(t){if(this._action!=t){this._action=t;var e=this._actions.get(this._action);e&&(this.initialize(e),this.play(12).loop())}},enumerable:!0,configurable:!0}),e}(vitamin.Animation);__reflect(Actor.prototype,"Actor");var KeyControlComp=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.speed=2,e}return __extends(e,t),e.prototype.onEnable=function(){vitamin.key.enabled=!0},e.prototype.onDisable=function(){vitamin.key.enabled=!1},e.prototype.onUpdate=function(){var t,e,i=this.speed,n=this.entity.raw,r=ecs.find("Map").find(MapGridComp);vitamin.key.isDown(vitamin.Keyboard.UP)?(t=Math.floor(n.x/16),e=Math.floor((n.y-i)/16),r.isWalkable(t,e)&&(n.y-=i)):vitamin.key.isDown(vitamin.Keyboard.DOWN)?(t=Math.floor(n.x/16),e=Math.floor((n.y+i)/16),r.isWalkable(t,e)&&(n.y+=i)):vitamin.key.isDown(vitamin.Keyboard.LEFT)?(t=Math.floor((n.x-i)/16),e=Math.floor(n.y/16),r.isWalkable(t,e)&&(n.x-=i,n.scaleX=-1)):vitamin.key.isDown(vitamin.Keyboard.RIGHT)&&(t=Math.floor((n.x+i)/16),e=Math.floor(n.y/16),r.isWalkable(t,e)&&(n.x+=i,n.scaleX=1)),ecs.find("Map").find(MapBitmapComp).cameraPosition.setTo(n.x,n.y)},e}(ecs.Component);__reflect(KeyControlComp.prototype,"KeyControlComp");var MapBitmapComp=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.scale=5,e}return __extends(e,t),e.prototype.onCreate=function(){this.cameraPosition=new egret.Point;var t=this.entity.raw,e=t.parent?t.parent:egret.lifecycle.stage;t.parent&&t.parent.removeChild(t);var i=t.getLayerByName("Wall"),n=t.getLayerByName("Floor");t.getLayerByName("Objects");n.mergeStaticAsBitmap(),i.mergeStaticAsBitmap();var r=this._bitmap=new MapBitmap(t);r.scaleX=r.scaleY=this.scale,e.addChild(r),r.addLight(50,50,50,16777215),r.addLight(50,50,150,10092441),r.addLight(50,350,150,16751001),r.addLight(450,50,150,10066431),r.addLight(450,350,150,16777113),r.touchEnabled=!0},e.prototype.onStart=function(){this._bitmap.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onTouch,this),shader.debug=!0},e.prototype.onDestory=function(){this._bitmap.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.onTouch,this)},e.prototype.onTouch=function(t){var e=this.entity.raw;if(e){var i=16*this._bitmap.scaleX,n=Math.floor((t.stageX-this._bitmap.x)/i),r=Math.floor((t.stageY-this._bitmap.y)/i);e.dispatchEventWith(t.type,!1,{x:n,y:r})}},e.prototype.onUpdate=function(){var t=this._bitmap;t.shader.setUniform("u_time",t.shader.getUniform("u_time")+1),t.shader.setUniform("u_sun",Math.min(1,Math.max(0,1-Math.abs(Math.sin(vitamin.ticker.curFrame/100)))));var e=this.cameraPosition;t.setLight(0,e.x,e.y,50*Math.abs(Math.sin(vitamin.ticker.curFrame/50))+50);var i=t.width*t.scaleX,n=t.height*t.scaleY;t.x=vitamin.stage.width/2-e.x/t.width*i,t.y=vitamin.stage.height/2-e.y/t.height*n},e}(ecs.Component);__reflect(MapBitmapComp.prototype,"MapBitmapComp");var MapBitmap=function(t){function e(e){var i=t.call(this)||this;return i.smoothing=!1,i.bind(e),i._shader=new shader.Shader("resource/filters/Tiled.frag",{uniforms:{u_time:0,u_sun:.1}}),i._shader.addTo(i),i._shader.onLoad(i,function(){i._fragSrc=i._shader.$fragmentSrc,vitamin.callLater(i,i.updateShader)}),i._lights=[],i}return __extends(e,t),Object.defineProperty(e.prototype,"shader",{get:function(){return this._shader},enumerable:!0,configurable:!0}),e.prototype.addLight=function(t,e,i,n){this._lights.push({x:t,y:e,radius:i,color:n}),vitamin.callLater(this,this.updateShader)},e.prototype.setLight=function(t,e,i,n,r){if(void 0!=e&&this._shader.setUniform("lightPos"+t+".x",e/this.width),void 0!=i&&this._shader.setUniform("lightPos"+t+".y",i/this.height),void 0!=n&&this._shader.setUniform("lightRadius"+t,n/this.width),void 0!=r){var a=vitamin.ColorUtil.extract(r),o=a[0],s=a[1],h=a[2];this._shader.setUniform("lightColor"+t+".x",o/255),this._shader.setUniform("lightColor"+t+".y",s/255),this._shader.setUniform("lightColor"+t+".z",h/255)}},e.prototype.updateShader=function(){if(this._lights.length&&this._fragSrc){for(var t=[],e=[],i=[],n={},r=0;r<this._lights.length;r++){var a=this._lights[r],o=vitamin.ColorUtil.extract(a.color),s=o[0],h=o[1],l=o[2];n["lightPos"+r]={x:a.x/this._bindTarget.width,y:a.y/this._bindTarget.height},n["lightRadius"+r]=a.radius/this._bindTarget.width,n["lightColor"+r]={x:s/255,y:h/255,z:l/255,w:1},i.push("uniform vec2 lightPos"+r+";"),i.push("uniform float lightRadius"+r+";"),i.push("uniform vec4 lightColor"+r+";"),e.push("light"+r),t.push("   vec4 light"+r+" = addlight(vTextureCoord, vec2(lightPos"+r+".x,1.0-lightPos"+r+".y), lightRadius"+r+", lightColor"+r+", vec4(0.0, 0.0, 0.0, 1.0));")}var c=this._fragSrc.replace("//{uniforms}",i.join("\n")).replace("//{lights}",t.join("\n")+"\n   vec4 light ="+e.join("+")+";");this._shader.update(this._shader.$shaderKey,{fragmentSrc:c,uniforms:n})}},e}(vitamin.RenderBitmap);__reflect(MapBitmap.prototype,"MapBitmap");var MapGridComp=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.onCreate=function(){var t=this.entity.raw;this._grid=new PF.Grid(t.rows,t.cols),this._astar=new PF.AStarFinder({allowDiagonal:!1,diagonalMovement:PF.DiagonalMovement.Never});for(var e=t.getLayerByName("Floor"),i=t.getLayerByName("Objects"),n=0;n<t.rows;n++)for(var r=0;r<t.cols;r++)this._grid.setWalkableAt(n,r,!!e.layerData[n][r]&&!i.layerData[n][r])},e.prototype.findPath=function(t,e,i,n){return this._grid.clearState(),this._astar.findPath(t,e,i,n,this._grid)},e.prototype.isWalkable=function(t,e){var i=this.entity.raw;if(!i)return!1;var n=i.getLayerByName("Floor"),r=i.getLayerByName("Objects");return t<n.layerData.length&&e<n.layerData[t].length?!!n.layerData[t][e]&&!r.layerData[t][e]:!1},e}(ecs.Component);__reflect(MapGridComp.prototype,"MapGridComp");var TapControlComp=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.speed=2,e}return __extends(e,t),e.prototype.onStart=function(){var t=this.entity.raw;ecs.find("Map").find(MapBitmapComp).cameraPosition.setTo(t.x,t.y),this.lastX=t.x},e.prototype.onEnable=function(){var t=ecs.find("Map");t&&t.raw&&t.raw.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onTouch,this)},e.prototype.onDisable=function(){var t=ecs.find("Map");t&&t.raw&&t.raw.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.onTouch,this)},e.prototype.onTouch=function(t){var e=ecs.find("Map").find(MapGridComp),i=this.entity.raw,n=Math.floor(i.x/16),r=Math.floor(i.y/16);this.path=e.findPath(n,r,t.data.x,t.data.y),this.moveStep()},e.prototype.moveStep=function(){this.endNode=null;var t=this.entity.raw;if(!this.path||!this.path.length)return void(t.action="idel");var e=this.path.shift();this.endNode={x:16*e.x+8,y:16*e.y+8},t.action="run"},e.prototype.onUpdate=function(){var t=this.speed,e=this.entity.raw;if(this.endNode){if(e.x!=this.endNode.x){var i=this.endNode.x-e.x;Math.abs(i)<t?e.x=this.endNode.x:e.x+=vitamin.MathUtil.sign(this.endNode.x-e.x)*t}if(e.y!=this.endNode.y){var n=this.endNode.y-e.y;Math.abs(n)<t?e.y=this.endNode.y:e.y+=vitamin.MathUtil.sign(this.endNode.y-e.y)*t}ecs.find("Map").find(MapBitmapComp).cameraPosition.setTo(e.x,e.y),this.lastX!=e.x&&(e.scaleX=e.x>=this.lastX?1:-1,this.lastX=e.x),e.x==this.endNode.x&&e.y==this.endNode.y&&this.moveStep()}},e}(ecs.Component);__reflect(TapControlComp.prototype,"TapControlComp");